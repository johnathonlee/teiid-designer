<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<chapter id="example-explained">
  <title>Example Explained</title>
  <sect1>
    <title>Portfolio Application Explained</title>
    <para>
      To demonstrate how Teiid Designer and Teiid work together, follow these steps to build a simple
      portfolio valuation virtual database. The investor's portfolio information is stored in a Derby database and
      "current" stock prices are stored in a delimited text file. When completed, a single query will cause
      Teiid to access the relational and non-relational sources, calculate the portfolio values, and
      return the results. Here are some of key points to consider as you build this example:
      <itemizedlist>
        <listitem>
          <para>It's pretty simple to do</para>
        </listitem>
        <listitem>
          <para>You're querying a text file as though it was a relational database</para>
        </listitem>
        <listitem>
          <para>Imagine how much more complete this would be if you replaced the text file with a connection
            to a financial Web site. (Hint: You can with Teiid and a custom connector.)</para>
        </listitem>
      </itemizedlist>
    </para>
    <figure id="steps">
      <title>Various Steps involved in creating the example</title>
      <graphic align="center" scale="100" fileref="../images/steps-defined.png" />
    </figure>
    <itemizedlist>
      <listitem>
        <para>
          <link linkend="step-1">Step-1: Create the Relational Database's schema and load the sample data</link>
        </para>
      </listitem>
      <listitem>
        <para>
          <link linkend="step-2">Step-2: Describe the CSV file and its contents</link>
        </para>
      </listitem>
      <listitem>
        <para>
          <link linkend="step-3">Step-3: Build a VDB</link>
        </para>
      </listitem>
      <listitem>
        <para>
          <link linkend="step-4">Step-4: Deploy the VDB in Teiid</link>
        </para>
      </listitem>
      <listitem>
        <para>
          <link linkend="step-5">Step-5: Access the VDB using JDBC API</link>
        </para>
      </listitem>
    </itemizedlist>
  </sect1>
  <note>
    <para>
      <ulink url="http://db.apache.org/derby/">Derby</ulink>
      is suggested as it is Open Source, easily obtained, and light-weight. You can substitute any other relational
      database, as long as you have a suitable JDBC driver. The schema file provided, and described below, is
      specific to Derby, but can be easily converted for use with other databases.
    </para>
  </note>
  <sect1 id="step-1">
    <title>Step-1: Create the Relational Database's schema and load the sample data</title>
    <para>
      This example is written using
      <ulink url="http://db.apache.org/derby/">"Derby"</ulink>
      as the relational database.
      <ulink url="http://db.apache.org/derby/derby_downloads.html">Download</ulink>
      and install Derby on your machine, or if you have access to an installed instance use that. It is
      expected that you create a database called "accounts" in this Derby instance that is used by this example
      application.
    </para>
    <para>
      Below find the corresponding schema. For the complete schema, please refer to
      <emphasis>"examples/portfolio/customer-schema.sql"</emphasis>
      file of the downloaded kit.
    </para>
    <programlisting><![CDATA[      
          - -Contains the name and address of a Customer who owns portfolio account 
          CREATE TABLE CUSTOMER
          ...
          
          --Contains Customer's account number and its current status
          CREATE TABLE ACCOUNT
          ...
                    
          --Contains information about stock symbol, company name etc.
          CREATE TABLE PRODUCT
          ...
          
          --Contains each Account's holdings of Stocks   
          CREATE TABLE HOLDINGS
          ...
    ]]>
    </programlisting>
    <para>We need to start the Derby RDBMS and create the "accounts" database with the below schema. These
      commands are intended for a Linux environment. For starting the Derby instance on another platform, you will need to use 
      commands appropariate to that platform.</para>
      <para>Start a terminal session, and change directory to where
      Derby is installed and execute following commands</para>
    <programlisting><![CDATA[
      export DERBY_HOME=`pwd`
      ./bin/startNetworkServer
    ]]>        
    </programlisting>
    <para>The above starts the Derby in network mode. Now, start another terminal and we will use Derby''s 'ij' tool 
    (like SQL*PLus for Oracle) to create the schema, using the "customer-schema.sql" file in
      "examples/portfolio" directory</para>
    <programlisting><![CDATA[
      export DERBY_HOME=`pwd`
      ./bin/ij /path/to/customer-schema.sql
      ]]>        
    </programlisting>
    <para>
      Make sure you did not have any issues when creating the schema as it is needed for going forward in this example.
      You can use 'ij' tool to verify the tables were created. As an alternative, you may use other tools like
      <ulink url="http://www.squirrelsql.org/">SQuirreL</ulink>
      , or
      <ulink url="http://www.eclipse.org/datatools/">Eclipse's Data Tools</ulink>
      plugin to connect to the Derby instance to check the schema and sample data.
    </para>
  </sect1>
  <sect1 id="step-2">
    <title>Step-2: Describe the CSV file and its contents</title>
    <para>In order to use a Text file as the source, we need to define two different types of files: A descriptor
      file and one or more data files. Conceptually, a Descriptor file defines a schema, and each data file defines
      data inside a table</para>
    <orderedlist>
      <listitem>
        <para>Text Descriptor File - The Text Descriptor file defines the structure
          of the text file you want to use as a data source. The path to the data file, delimiter character used,and the number
          of header lines are attributes of the Descriptor file.
          A sample descriptor file is shown below.</para>
        <programlisting><![CDATA[
            MarketData.Price.location = /path/to/marketdata-price.txt
            MarketData.Price.delimiter = ,
            MarketData.Price.headerLine = 1
         ]]>        
        </programlisting>
        <para>The table shown below details some of the available properties that can be used in a Descriptor file. For
          full details look in Text File Connector documentation</para>
        <table frame="all">
          <title>Connection Properties</title>
          <tgroup cols='2' align='left' colsep='1' rowsep='1'>
            <colspec colname='c1' colwidth="1*" />
            <colspec colname='c2' colwidth="1*" />
            <thead>
              <row>
                <entry>
                  <para>Property</para>
                </entry>
                <entry>
                  <para>Description</para>
                </entry>
              </row>
            </thead>
            <tbody>
              <row>
                <entry>
                  <para>location</para>
                </entry>
                <entry>
                  <para>The path to the file on the local system or URL to remote file.</para>
                </entry>
              </row>
              <row>
                <entry>
                  <para>delimiter</para>
                </entry>
                <entry>
                  <para>The character the file uses to delimit the fields within each line in the file</para>
                </entry>
              </row>
              <row>
                <entry>
                  <para>headerLine</para>
                </entry>
                <entry>
                  <para>The line number in which the names of the columns are defined</para>
                </entry>
              </row>
              <row>
                <entry>
                  <para>skipHeaderLines</para>
                </entry>
                <entry>
                  <para>The number of top lines to skip in a text file (include one for the header).</para>
                </entry>
              </row>
            </tbody>
          </tgroup>
        </table>
        <para>Note that each property line starts with the "schema" information and followed by the logical "table"
          name and then the "property" itself. In the above sample file "MarketData" is the schema and "Price" is
          the table. The sample Descriptor file is for a 'single' table. You can define multiple tables in the 
          same Descriptor file, but each "location" property for a given "table" must point to different data file.</para>
      </listitem>
      <listitem>
        <para>Data File: This is the file that is identified by the "location" property in the Descriptor file.
          Each data file contains column information for the table. The
          column information is typically defined on line 1 as header line in the file, and all the following lines
          contain the actual rows of data. Each single line corresponds to single row. A portion of the sample file
          is shown below. The complete sample file is "examples/portfolio/marketdata-price.txt".</para>
        <programlisting><![CDATA[
           SYMBOL,PRICE
           IBM,83.46
           RHT,11.84
           BA, 44.58
           ORCL,17.37           
         ]]>        
        </programlisting>
      </listitem>
    </orderedlist>
    <para>Just locate the sample data files provided or create your own data files. Make sure that the
      descriptor file contains the full path to the data file. Now, both our sources are ready to be
      used to build a VDB</para>
  </sect1>
</chapter>